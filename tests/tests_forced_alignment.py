from asr_inference import ASRInference
from utils import convert_wav, filter, normalize_forced_alignment
from main import model_config


def test_forced_alignment_normal_10sec():
    
    """кейс с входными на 10 секунд, в качестве ETALON'а был взят выход от GigaAM"""
    
    ETALON_OUTPUT = normalize_forced_alignment([['то', 0.0, 0.202875], ['как', 0.2608125, 0.3478125], ['мы', 0.43475, 0.49275], ['его', 0.5506875, 0.637625], ['воспринимаем', 0.724625, 1.47825], ['нравится', 1.681125, 2.1159375], ['он', 2.2608125, 2.3188125], ['нам', 2.43475, 2.5506875], ['или', 2.637625, 2.7535625], ['нет', 2.8405625, 3.0434375], ['кажется', 3.159375, 3.47825], ['он', 3.5651875, 3.652125],
                                                ['бесклявым', 3.942, 4.637625], ['или', 4.724625, 4.8405625], ['наоборот', 4.8985, 5.217375], ['бархатным', 5.3333125, 5.8260625], ['глубоким', 5.913, 6.2898125], ['и', 6.3478125, 6.37675], ['красивым', 6.46375, 7.0434375], ['это', 7.217375, 7.3333125], ['наверное', 7.42025, 7.7680625], ['то', 7.884, 7.971], ['что', 8.0869375, 8.173875],
                                                ['больше', 8.3188125, 8.5506875], ['всего', 8.637625, 8.9275], ['влияет', 9.0434375, 9.47825], ['на', 9.5651875, 9.6231875], ['нашего', 9.681125, 9.971]])

    SPEECH_FILE = "data_for_tests/test_10.wav"
    speech = convert_wav(SPEECH_FILE)

    model = ASRInference('GigaAM', model_config)
    output = normalize_forced_alignment(model.forced_align(speech))

    assert output == ETALON_OUTPUT


def test_forced_alignment_normal_60sec():
    
    """кейс с входными на 60 секунд, в качестве ETALON'а был взят выход от GigaAM"""
    
    ETALON_OUTPUT = normalize_forced_alignment([['то', 0.0, 0.2398125], ['как', 0.31975, 0.4396875], ['мы', 0.4796875, 0.559625], ['его', 0.6395625, 0.7595], ['воспринимаем', 0.8794375, 1.559], ['нравится', 1.6789375, 2.118625], ['он', 2.2385625, 2.3585], ['нам', 2.4384375, 2.558375], ['или', 2.6783125, 2.79825], ['нет', 2.918125, 3.0780625], ['кажется', 3.198, 3.51775],
                                                ['он', 3.59775, 3.717625], ['песклявым', 3.9175, 4.597125], ['или', 4.6770625, 4.8369375], ['наоборот', 4.8769375, 5.2766875], ['бархатным', 5.396625, 5.8363125], ['глубоким', 5.95625, 6.356], ['и', 6.4359375, 6.4759375], ['красивым', 6.555875, 7.0355625], ['это', 7.1955, 7.3154375], ['наверное', 7.395375, 7.795125],
                                                ['то', 7.9150625, 7.995], ['что', 8.0749375, 8.2348125], ['больше', 8.3148125, 8.594625], ['всего', 8.6745625, 8.954375], ['влияет', 9.0743125, 9.434125], ['на', 9.554, 9.634], ['наше', 9.7139375, 9.9138125], ['восприятие', 9.99375, 10.553375], ['голоса', 10.6733125, 10.953125], ['того', 11.033125, 11.233], ['или', 11.352875, 11.4728125],
                                                ['иного', 11.63275, 11.9125625], ['человека', 11.9925, 12.5521875], ['именно', 15.86565625, 16.26484375], ['поэтому', 16.34465625, 16.703906250000003], ['в', 16.823656250000003, 16.86359375], ['сегодняшнем', 16.943406250000002, 17.462343750000002], ['выпуске', 17.54221875, 17.861531250000002], ['мы', 18.021218750000003, 18.10109375],
                                                ['вместе', 18.18090625, 18.46034375], ['с', 18.580093750000003, 18.62003125], ['вами', 18.69984375, 18.859531250000003], ['постараемся', 18.97928125, 19.53815625], ['ответить', 19.657906250000003, 20.01715625], ['на', 20.096968750000002, 20.176843750000003], ['вопросы', 20.256656250000002, 20.73565625], ['можно', 20.975218750000003, 21.25459375],
                                                ['ли', 21.37440625, 21.454218750000003], ['изменить', 21.53403125, 21.89334375], ['тот', 21.973156250000002, 22.092906250000002], ['тембр', 22.17271875, 22.492093750000002], ['голоса', 22.611843750000002, 22.891281250000002], ['который', 22.97109375, 23.290468750000002], ['дан', 23.37028125, 23.569906250000003], ['нам', 23.64971875, 23.76946875],
                                                ['при', 23.88921875, 24.088843750000002], ['рождении', 24.16865625, 24.607781250000002], ['и', 24.76746875, 24.80734375], ['если', 24.887218750000002, 25.126718750000002], ['можно', 25.246468750000002, 25.60571875], ['то', 25.805343750000002, 25.925093750000002], ['как', 26.00490625, 26.16459375], ['его', 26.28434375, 26.40409375], ['улучшить', 26.483906250000004, 26.88309375],
                                                ['как', 26.96296875, 27.08271875], ['сделать', 27.16253125, 27.48190625], ['его', 27.521781250000004, 27.641593750000002], ['более', 27.76134375, 28.00084375], ['красивым', 28.08065625, 28.559718750000002], ['и', 28.63953125, 28.71934375], ['приятным', 28.79921875, 29.43790625], ['клубничкой', 34.40471875, 35.38409375], ['начнем', 37.27409375, 37.63371875], ['с', 37.71359375, 37.75359375],
                                                ['ответа', 37.83346875, 38.073218749999995], ['на', 38.15315625, 38.23309375], ['первый', 38.273031249999995, 38.552781249999995], ['вопрос', 38.63265625, 38.95234375], ['можем', 39.15215625, 39.39190625], ['ли', 39.47184375, 39.55171875], ['мы', 39.63165625, 39.71159375], ['изменить', 39.79146875, 40.15115625], ['тот', 40.19109375, 40.31096875], ['тембр', 40.39090625, 40.710531249999995],
                                                ['голоса', 40.79046875, 41.070218749999995], ['который', 41.190093749999996, 41.50971875], ['дан', 41.58965625, 41.74953125], ['нам', 41.82940625, 41.94928125], ['при', 42.06915625, 42.22903125], ['рождении', 42.30890625, 42.78846875], ['для', 42.94828125, 43.108093749999995], ['этого', 43.14809375, 43.38784375], ['нам', 43.427781249999995, 43.547656249999996], ['естественно', 43.62759375, 44.18703125],
                                                ['необходимо', 44.26696875, 44.66653125], ['разобраться', 44.74646875, 45.26590625], ['в', 45.30590625, 45.38578125], ['процессе', 45.42578125, 45.82534375], ['звукоизлечения', 45.90528125, 46.66446875], ['то', 46.70446875, 46.82434375], ['есть', 46.86428125, 47.06409375], ['как', 47.14403125, 47.26390625], ['вообще', 47.34378125, 47.62353125], ['формируется', 47.70340625, 48.22290625],
                                                ['наш', 48.34278125, 48.462656249999995], ['тембр', 48.542593749999995, 48.862281249999995], ['голоса', 48.94215625, 49.221906249999996], ['на', 49.34178125, 49.42165625], ['картинке', 49.50159375, 49.86121875], ['вы', 50.02109375, 50.10096875], ['видите', 50.22084375, 50.54053125], ['важнейшую', 50.78028125, 51.41965625], ['часть', 51.539531249999996, 51.81921875], ['нашего', 51.93909375, 52.21884375],
                                                ['голосового', 52.29878125, 52.77828125], ['аппарата', 52.85815625, 53.25778125], ['который', 53.33771874999999, 53.657343749999995], ['называется', 53.737281249999995, 54.17684375], ['голосовые', 54.25678125, 54.69628125], ['складки', 54.77621875, 55.13584375], ['именно', 55.25571875, 55.61540625], ['благодаря', 55.695281249999994, 56.094906249999994], ['колебанию', 56.174781249999995, 56.69428125],
                                                ['этих', 56.85409375, 57.013968750000004], ['складок', 57.09384375, 57.49346875], ['и', 57.57340625, 57.65328125], ['рождается', 57.73321875, 58.21271874999999], ['звуковая', 58.33259375, 58.73221875], ['волна', 58.81209375, 59.13178125], ['которая', 59.251656249999996, 59.65128125]])

    SPEECH_FILE = "data_for_tests/test_60.wav"
    speech = convert_wav(SPEECH_FILE)

    model = ASRInference('GigaAM', model_config)
    output = normalize_forced_alignment(model.forced_align(speech))

    assert output == ETALON_OUTPUT
